{% extends 'authentication/base.html' %}
{% load custom_filters %}
{% block content %}
<style>
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    .status-active {
        background-color: #28a745;
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
    }
    .status-inactive {
        background-color: #dc3545;
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
    }
    .status-text {
        display: inline-flex;
        align-items: center;
        font-weight: 500;
    }
    .status-active + .status-text {
        color: #28a745;
    }
    .status-inactive + .status-text {
        color: #dc3545;
    }
    .last-activity {
        font-size: 0.9em;
        color: #666;
    }
    .text-success {
        color: #28a745;
    }
    .text-danger {
        color: #dc3545;
    }
</style>


<div class="container mt-4">
    <!-- Debug info -->
    <div id="debug-info" style="display: none;">
        <pre id="debug-content"></pre>
    </div>

    <!-- Hidden div to store user IDs -->
    <div id="user-stats" data-user-ids="{% for stat in stats %}{{ stat.user.id|stringformat:"s" }}{% if not forloop.last %},{% endif %}{% endfor %}"></div>

    <h2 class="mb-4">Thống kê thời gian làm việc</h2>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Từ ngày</label>
                    <input type="date" name="start_date" class="form-control" 
                           value="{{ start_date|date:'Y-m-d' }}" 
                           min="2025-01-01" 
                           max="2025-12-31">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Đến ngày</label>
                    <input type="date" name="end_date" class="form-control" 
                           value="{{ end_date|date:'Y-m-d' }}" 
                           min="2025-01-01" 
                           max="2025-12-31">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Nhân viên</label>
                    <select name="user_id" class="form-select">
                        <option value="">Tất cả</option>
                        {% for user in users %}
                        <option value="{{ user.user_id|stringformat:"s" }}" {% if selected_user == user.user_id|stringformat:"s" %}selected{% endif %}>
                            {{ user.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary" name="export" value="true">Xuất excel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nhân viên</th>
                            <th>Số phiên đăng nhập</th>
                            <th>Tổng thời gian (giờ)</th>
                            <th>Thời gian trung bình/phiên (giờ)</th>
                            <th>Trạng thái hoạt động</th>
                            <th>Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in stats %}
                        <tr data-user-id="{{ stat.user.id|stringformat:"s" }}">
                            <td>{{ stat.user.username }}</td>
                            <td>{{ stat.total_sessions }}</td>
                            <td>{{ stat.total_hours }}</td>
                            <td>{{ stat.average_session }}</td>
                            <td class="activity-status">
                                <span class="status-container" data-user-id="{{ stat.user.id|stringformat:"s" }}">
                                    <span class="status-indicator"></span>
                                    <span class="status-text"></span>
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#details-{{ stat.user.id|stringformat:"s" }}">
                                    Xem chi tiết
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6">
                                <div class="collapse" id="details-{{ stat.user.id|stringformat:"s" }}">
                                    <div class="card card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Thời gian đăng nhập</th>
                                                        <th>Thời gian đăng xuất</th>
                                                        <th>Thời gian làm việc</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="activity-details-{{ stat.user.id|stringformat:"s" }}">
                                                    {% for activity in stat.activities|dictsortreversed:"login_time"|slice:":20" %}
                                                    <tr data-user-id="{{ stat.user.id|stringformat:"s" }}" data-session-id="{{ activity.session_id }}">
                                                        <td>{% if activity.login_time %}{{ activity.login_time|date:"d/m/Y H:i" }}{% else %}Chưa có dữ liệu{% endif %}</td>
                                                        <td>{% if activity.logout_time %}{{ activity.logout_time|date:"d/m/Y H:i" }}{% else %}Chưa đăng xuất{% endif %}</td>
                                                        <td>
                                                            <span class="activity-duration" id="duration-{{ activity.session_id }}">
                                                                {{ activity.session_duration|format_duration }}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let socket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const statusContainers = new Map();
    const pendingUpdates = new Map();

    function connectWebSocket() {
        if (socket) {
            socket.close();
        }

        // Xác định protocol và host dựa trên môi trường
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.hostname;
        const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
        const wsUrl = `${wsProtocol}//${host}:${port}/ws/user_activity/`;
        
        console.log('Connecting to WebSocket:', wsUrl);
        
        try {
            socket = new WebSocket(wsUrl);
            let heartbeatInterval = null;
            let missedHeartbeats = 0;
            const maxMissedHeartbeats = 3;
            let reconnectTimeout = null;
            let isReconnecting = false;

            // Thêm timeout cho kết nối ban đầu
            const connectionTimeout = setTimeout(() => {
                if (socket.readyState !== WebSocket.OPEN) {
                    console.error('WebSocket connection timeout');
                    socket.close();
                    // Thử kết nối với host nếu local thất bại
                    if (host === 'localhost' || host === '127.0.0.1') {
                        const hostWsUrl = `${wsProtocol}//207.148.69.229:81/ws/user_activity/`;
                        console.log('Trying host connection:', hostWsUrl);
                        socket = new WebSocket(hostWsUrl);
                    }
                }
            }, 5000);

            socket.onopen = function(e) {
                clearTimeout(connectionTimeout);
                console.log('WebSocket connected successfully to:', wsUrl);
                reconnectAttempts = 0;
                isReconnecting = false;
                socket.send(JSON.stringify({type: 'get_initial_status'}));

                // Bắt đầu kiểm tra heartbeat
                heartbeatInterval = setInterval(() => {
                    if (missedHeartbeats >= maxMissedHeartbeats) {
                        console.log('Too many missed heartbeats, reconnecting...');
                        clearInterval(heartbeatInterval);
                        socket.close();
                        if (!isReconnecting) {
                            isReconnecting = true;
                            reconnectTimeout = setTimeout(() => {
                                connectWebSocket();
                            }, 1000);
                        }
                    }
                }, 35000);
            };

            socket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    if (data.type === 'ping') {
                        // Reset missed heartbeats counter và trả lời pong
                        missedHeartbeats = 0;
                        socket.send(JSON.stringify({type: 'pong'}));
                        return;
                    }

                    // Xử lý các loại tin nhắn khác
                    if (data.type === 'activity_status') {
                        queueStatusUpdate(data);
                    } else if (data.type === 'initial_status' && Array.isArray(data.statuses)) {
                        data.statuses.forEach(status => {
                            setTimeout(() => queueStatusUpdate(status), 0);
                        });
                    }
                } catch (error) {
                    console.error('Error processing message:', error);
                }
            };

            socket.onerror = function(e) {
                clearTimeout(connectionTimeout);
                clearInterval(heartbeatInterval);
                console.error('WebSocket error:', e);
                
                if (!isReconnecting && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    isReconnecting = true;
                    reconnectTimeout = setTimeout(() => {
                        connectWebSocket();
                    }, Math.min(1000 * Math.pow(2, reconnectAttempts), 30000)); // Exponential backoff with max 30s
                }
            };

            socket.onclose = function(e) {
                clearTimeout(connectionTimeout);
                clearInterval(heartbeatInterval);
                console.log('WebSocket connection closed:', e);
                
                if (!isReconnecting && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    isReconnecting = true;
                    reconnectTimeout = setTimeout(() => {
                        connectWebSocket();
                    }, Math.min(1000 * Math.pow(2, reconnectAttempts), 30000));
                }
            };

            return () => {
                // Cleanup function
                clearTimeout(connectionTimeout);
                clearInterval(heartbeatInterval);
                clearTimeout(reconnectTimeout);
                if (socket) {
                    socket.close();
                }
            };
        } catch (error) {
            console.error('Error creating WebSocket:', error);
        }
    }

    function updateUserStatus(data) {
        if (!data || typeof data !== 'object') {
            console.error('Invalid data received:', data);
            return;
        }

        if (!data.user_id) {
            console.error('Missing user_id in data:', data);
            return;
        }

        // Đợi DOM load xong
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => processStatusUpdate(data));
            return;
        }

        processStatusUpdate(data);
    }

    function processStatusUpdate(data) {
        // Kiểm tra xem container đã được tìm thấy trước đó chưa
        let statusContainer = statusContainers.get(data.user_id);
        
        // Nếu chưa, thử tìm lại
        if (!statusContainer) {
            statusContainer = document.querySelector(`.status-container[data-user-id="${data.user_id}"]`);
            if (statusContainer) {
                statusContainers.set(data.user_id, statusContainer);
            }
        }

        // Nếu không tìm thấy container, bỏ qua
        if (!statusContainer) {
            console.warn(`Status container not found for user ${data.user_id}`);
            return;
        }

        const statusIndicator = statusContainer.querySelector('.status-indicator');
        const statusText = statusContainer.querySelector('.status-text');

        if (!statusIndicator || !statusText) {
            console.warn(`Missing status elements for user ${data.user_id}`);
            return;
        }

        const isActive = Boolean(data.is_active);

        try {
            // Cập nhật trạng thái chính
            requestAnimationFrame(() => {
                statusIndicator.className = `status-indicator ${isActive ? 'status-active' : 'status-inactive'}`;
                statusText.textContent = isActive ? 'Đang hoạt động' : 'Đã đăng xuất';
                statusText.className = `status-text ${isActive ? 'text-success' : 'text-danger'}`;
            });

            // Cập nhật session nếu có
            if (data.session_id) {
                updateSessionStatus(data);
            }
        } catch (error) {
            console.error('Error updating status:', error);
        }
    }

    function updateSessionStatus(data) {
        const sessionRow = document.querySelector(`tr[data-session-id="${data.session_id}"]`);
        if (!sessionRow) {
            console.log(`Session row not found for session_id: ${data.session_id}`);
            return;
        }

        const isActive = Boolean(data.is_active);
        const sessionStatus = sessionRow.querySelector('.status-indicator');
        const sessionText = sessionRow.querySelector('.status-text');
        const logoutTimeElement = document.getElementById(`logout-time-${data.session_id}`);

        if (sessionStatus && sessionText) {
            requestAnimationFrame(() => {
                try {
                    sessionStatus.className = `status-indicator ${isActive ? 'status-active' : 'status-inactive'}`;
                    sessionText.textContent = isActive ? 'Đang hoạt động' : 'Đã đăng xuất';
                    sessionText.className = `status-text ${isActive ? 'text-success' : 'text-danger'}`;

                    // Cập nhật thời gian đăng xuất nếu có
                    if (data.logout_time) {
                        const logoutTime = new Date(data.logout_time);
                        logoutTimeElement.innerHTML = logoutTime.toLocaleString('vi-VN', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } else if (!isActive) {
                        logoutTimeElement.innerHTML = '<span class="text-muted">Chưa có dữ liệu đăng xuất</span>';
                    }
                } catch (error) {
                    console.error('Error updating session status:', error);
                }
            });
        } else {
            console.warn('Missing status elements for session:', data.session_id);
        }
    }

    // Queue system
    const updateQueue = new Map();
    let isProcessingQueue = false;

    function queueStatusUpdate(data) {
        updateQueue.set(data.user_id, data);
        if (!isProcessingQueue) {
            setTimeout(processUpdateQueue, 100); // Đợi 100ms trước khi xử lý queue
        }
    }

    function processUpdateQueue() {
        if (updateQueue.size === 0) {
            isProcessingQueue = false;
            return;
        }

        isProcessingQueue = true;

        const processedIds = [];
        
        updateQueue.forEach((data, userId) => {
            try {
                processStatusUpdate(data);
                processedIds.push(userId);
            } catch (error) {
                console.error('Error processing queued update for user:', userId, error);
            }
        });

        // Xóa các updates đã xử lý
        processedIds.forEach(id => updateQueue.delete(id));

        // Nếu còn updates trong queue, tiếp tục xử lý
        if (updateQueue.size > 0) {
            setTimeout(processUpdateQueue, 100);
        } else {
            isProcessingQueue = false;
        }
    }

    // Hàm chuẩn hóa user ID
    function normalizeUserId(userId) {
        try {
            // Đảm bảo ID luôn là string và loại bỏ khoảng trắng
            const normalized = String(userId).trim();
            console.log('Normalizing user ID:', { 
                original: userId, 
                normalized: normalized,
                type: typeof normalized
            });
            return normalized;
        } catch (e) {
            console.error('Lỗi khi chuẩn hóa user ID:', e);
            return null;
        }
    }

    // Hàm tìm status container với xử lý ID linh hoạt
    function findStatusContainer(userId, updateData = null) {
        const normalizedId = normalizeUserId(userId);
        if (!normalizedId) {
            console.error('Invalid user ID:', userId);
            return null;
        }

        console.log('Finding container for user ID:', { 
            original: userId, 
            normalized: normalizedId,
            cached: statusContainers.has(normalizedId)
        });

        // Kiểm tra cache trước
        if (statusContainers.has(normalizedId)) {
            const container = statusContainers.get(normalizedId);
            console.log('Found container in cache:', container);
            return container;
        }

        // Tìm trong DOM với nhiều cách khác nhau
        let container = document.querySelector(`.status-container[data-user-id="${normalizedId}"]`);
        console.log('Direct query result:', container);
        
        // Nếu không tìm thấy, thử tìm trong tất cả các container
        if (!container) {
            console.log('Searching in all containers...');
            const allContainers = document.querySelectorAll('.status-container');
            console.log('Total containers found:', allContainers.length);
            
            for (const cont of allContainers) {
                const containerId = normalizeUserId(cont.getAttribute('data-user-id'));
                console.log('Checking container:', { 
                    element: cont,
                    id: containerId,
                    matches: containerId === normalizedId,
                    containerIdType: typeof containerId,
                    normalizedIdType: typeof normalizedId
                });
                
                if (containerId === normalizedId) {
                    container = cont;
                    break;
                }
            }
        }

        // Nếu tìm thấy, lưu vào cache
        if (container) {
            console.log('Caching container for ID:', normalizedId);
            statusContainers.set(normalizedId, container);
        } else if (updateData) {
            console.warn('No container found for ID:', normalizedId);
            // Lưu update vào pending queue
            if (pendingUpdates.has(normalizedId)) {
                const updates = pendingUpdates.get(normalizedId);
                updates.push(updateData);
            } else {
                pendingUpdates.set(normalizedId, [updateData]);
            }
        }

        return container;
    }

    // Debug function
    function debugLog(message, data) {
        const debugContent = document.getElementById('debug-content');
        if (debugContent) {
            const timestamp = new Date().toISOString();
            const logMessage = `[${timestamp}] ${message}: ${JSON.stringify(data, null, 2)}\n`;
            debugContent.textContent += logMessage;
        }
        console.log(message, data);
    }

    // Khởi tạo khi DOM đã sẵn sàng
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('Initializing status containers...');
        
        // Log all user IDs from the hidden div
        const userStatsDiv = document.getElementById('user-stats');
        const allUserIds = userStatsDiv ? userStatsDiv.getAttribute('data-user-ids').split(',') : [];
        debugLog('All user IDs from data attribute:', allUserIds);

        // Lưu trữ tất cả các container vào Map với ID đã chuẩn hóa
        const containers = document.querySelectorAll('.status-container');
        debugLog('Found containers:', containers.length);
        
        containers.forEach(container => {
            const userId = container.getAttribute('data-user-id');
            if (userId) {
                const normalizedId = normalizeUserId(userId);
                if (normalizedId) {
                    debugLog('Caching container:', { 
                        originalId: userId,
                        normalizedId: normalizedId,
                        container: container,
                        originalType: typeof userId,
                        normalizedType: typeof normalizedId
                    });
                    statusContainers.set(normalizedId, container);
                }
            }
        });
        
        debugLog('Cached containers:', Array.from(statusContainers.keys()));

        // Xử lý các pending updates
        if (pendingUpdates.size > 0) {
            debugLog('Processing pending updates:', pendingUpdates.size);
            pendingUpdates.forEach((updates, userId) => {
                const container = findStatusContainer(userId);
                if (container) {
                    updates.forEach(update => {
                        updateStatusDisplay(container, update);
                    });
                    pendingUpdates.delete(userId);
                }
            });
        }
        
        // Kết nối WebSocket
        connectWebSocket();
    });
</script>
{% endblock %} 