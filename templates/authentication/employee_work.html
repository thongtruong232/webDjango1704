<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Quản lý Email</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --background-color: #f8f9fa;
            --border-color: #dee2e6;
        }

        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 1400px;
            padding: 20px;
            margin: 0 auto;
        }

        /* Table Styles */
        .email-table {
            max-height: 750px; /* Chiều cao cho 15 dòng (15 * 40px chiều cao mỗi dòng + header) */
            overflow-y: auto;
            position: relative;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            border: none;
            padding: 12px;
            white-space: nowrap;
        }

        .table td {
            height: 40px; /* Chiều cao cố định cho mỗi dòng */
            padding: 8px 12px;
            vertical-align: middle;
        }

        .email-row:hover {
            background-color: rgba(52, 152, 219, 0.05);
            transition: background-color 0.2s ease;
        }

        /* Button Styles */
        .provide-email-btn {
            background-color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .provide-email-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .provide-email-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-success {
            background-color: var(--success-color);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-1px);
        }

        /* Select Styles */
        .status-select-tn, .status-select-tf {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .status-select-tn:focus, .status-select-tf:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        .loader {
            display: inline-block;
            width: 100px;
            height: 100px;
            position: relative;
        }

        .loader svg {
            width: 100%;
            height: 100%;
            animation: rotate-svg 2s linear infinite;
            transform-origin: center center;
        }

        .loader-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .circle-1 {
            stroke-dasharray: 251.3274; /* 2 * π * 40 */
            stroke-dashoffset: 251.3274;
            animation: dash-circle1 1.5s cubic-bezier(0.66, 0, 0.34, 1) infinite alternate;
        }

        .circle-2 {
            stroke-dasharray: 188.4956; /* 2 * π * 30 */
            stroke-dashoffset: 0;
            animation: dash-circle2 1.5s cubic-bezier(0.66, 0, 0.34, 1) infinite alternate;
        }

        @keyframes rotate-svg {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes dash-circle1 {
            0% {
                stroke-dashoffset: 251.3274;
            }
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes dash-circle2 {
            0% {
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dashoffset: 188.4956;
            }
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .table-responsive {
                border: none;
                margin-bottom: 0;
            }

            .table th, .table td {
                min-width: 150px;
            }

            .table td:first-child {
                position: sticky;
                left: 0;
                background-color: white;
                z-index: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }

            .table th, .table td {
                padding: 10px;
                font-size: 14px;
            }
        }

        /* Custom Scrollbar */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Màu sắc cho các option trong select box */
        .status-select-tn option[value="chưa tạo acc"],
        .status-select-tf option[value="chưa tạo acc"] {
            background-color: white;
            color: black;
        }

        .status-select-tn option[value="chưa recend link"],
        .status-select-tf option[value="chưa recend link"] {
            background-color: #8e44ad; /* Màu tím */
            color: white;
        }

        .status-select-tn option[value="mail lỗi"],
        .status-select-tf option[value="mail lỗi"] {
            background-color: #e74c3c; /* Màu đỏ */
            color: white;
        }

        .status-select-tn option[value="reg acc lỗi"],
        .status-select-tf option[value="reg acc lỗi"] {
            background-color: #e67e22; /* Màu cam */
            color: white;
        }

        .status-select-tn option[value="tạo acc thành công"],
        .status-select-tf option[value="tạo acc thành công"] {
            background-color: #2ecc71; /* Màu xanh lá */
            color: white;
        }

        /* Thêm CSS để hiển thị màu sắc cho select box khi đã chọn */
        .status-select-tn, .status-select-tf {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            width: 100%;
            font-size: 14px;
        }

        /* Màu nền cho select box dựa trên giá trị đã chọn */
        .status-select-tn[data-value="chưa tạo acc"],
        .status-select-tf[data-value="chưa tạo acc"] {
            background-color: white;
            color: black;
        }

        .status-select-tn[data-value="chưa recend link"],
        .status-select-tf[data-value="chưa recend link"] {
            background-color: #8e44ad;
            color: white;
        }

        .status-select-tn[data-value="mail lỗi"],
        .status-select-tf[data-value="mail lỗi"] {
            background-color: #e74c3c;
            color: white;
        }

        .status-select-tn[data-value="reg acc lỗi"],
        .status-select-tf[data-value="reg acc lỗi"] {
            background-color: #e67e22;
            color: white;
        }

        .status-select-tn[data-value="tạo acc thành công"],
        .status-select-tf[data-value="tạo acc thành công"] {
            background-color: #2ecc71;
            color: white;
        }

        .status-select-tn:disabled,
        .status-select-tf:disabled,
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Thêm vào phần style của bạn */
        .completed-status {
            background-color: #f8f9fa !important;
            border-color: #dee2e6 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            /* Giữ màu chữ và background theo trạng thái */
            opacity: 0.9;
            font-weight: 500;
        }

        /* Cập nhật style cho select box disabled */
        .status-select-tn:disabled,
        .status-select-tf:disabled {
            opacity: 0.9;
            cursor: not-allowed;
        }

        /* Style cho option trong select box disabled */
        .completed-status option {
            background-color: inherit;
            color: inherit;
        }

        /* Thêm vào phần style */
        .status-display {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        .status-display[data-status="chưa tạo acc"] {
            background-color: white;
            color: black;
            border: 1px solid var(--border-color);
        }

        .status-display[data-status="chưa recend link"] {
            background-color: #8e44ad;
            color: white;
        }

        .status-display[data-status="mail lỗi"] {
            background-color: #e74c3c;
            color: white;
        }

        .status-display[data-status="reg acc lỗi"] {
            background-color: #e67e22;
            color: white;
        }

        .status-display[data-status="tạo acc thành công"] {
            background-color: #2ecc71;
            color: white;
        }

        /* Giữ header cố định khi cuộn */
        .email-table thead {
            position: sticky;
            top: 0;
            z-index: 2;
            background-color: var(--primary-color);
        }

        /* Style cho thanh cuộn dọc */
        .email-table::-webkit-scrollbar {
            width: 8px;
        }

        .email-table::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .email-table::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .email-table::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Đảm bảo các cột có chiều rộng phù hợp */
        .table th, .table td {
            white-space: nowrap;
            padding: 12px;
        }

        /* Style cho nút Tạo TN - màu tím */
        .create-textnow-btn {
            background-color: #8e44ad !important; /* Màu tím */
            border-color: #8e44ad !important;
            color: white !important;
            transition: all 0.3s ease;
        }

        .create-textnow-btn:hover {
            background-color: #732d91 !important; /* Màu tím đậm hơn khi hover */
            border-color: #732d91 !important;
            transform: translateY(-1px);
        }

        /* Style cho nút Tạo TF - màu xanh da trời */
        .create-textfree-btn {
            background-color: #3498db !important; /* Màu xanh da trời */
            border-color: #3498db !important;
            color: white !important;
            transition: all 0.3s ease;
        }

        .create-textfree-btn:hover {
            background-color: #2980b9 !important; /* Màu xanh da trời đậm hơn khi hover */
            border-color: #2980b9 !important;
            transform: translateY(-1px);
        }

        /* Style cho các nút khi disabled */
        .create-textnow-btn:disabled,
        .create-textfree-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }

        .bulk-create-btn {
            background-color: #f39c12 !important;
            border-color: #f39c12 !important;
            color: white !important;
            transition: all 0.3s ease;
        }

        .bulk-create-btn:hover {
            background-color: #d68910 !important;
            border-color: #d68910 !important;
            transform: translateY(-1px);
        }

        .bulk-create-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
    </style>
</head>
<body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Danh sách Email</h2>
                <div class="d-flex gap-3">
                    <button id="bulkCreateTNBtn" class="btn btn-warning bulk-create-btn">Cập nhật hàng loạt TN</button>
                    <button id="bulkCreateTFBtn" class="btn btn-success bulk-create-btn">Cập nhật hàng loạt TF</button>
                    <button id="provideEmailBtn" class="btn btn-primary provide-email-btn">Lấy Mail Kho</button>
                </div>
            </div>
            <div class="table-responsive email-table">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>STT</th>
                <th>Email</th>
                            <th>Pass Mail</th>
                            {% comment %} <th>Status</th> {% endcomment %}
                            <th>Pass Reg TextNow</th>
                            <th>Pass Reg TextFree</th>
                            <th>Status Reg TN</th>
                            <th>Status Reg TF</th>
                            <th>Tạo acc TN</th>
                            <th>Tạo acc TF</th>
                            {% comment %} <th>Tạo acc TF</th> {% endcomment %}
            </tr>
        </thead>
                    <tbody id="emailList">
                        {% if emails %}
                            {% for email in emails %}
                                <tr class="email-row">
                                    <td>{{ forloop.counter }}</td>
                                    <td data-refresh-token="{{ email.refresh_token }}" data-client-id="{{ email.client_id }}">{{ email.email }}</td>
                                    <td>{{ email.password }}</td>
                                    {% comment %} <td>{{ email.status }}</td> {% endcomment %}
                                    <td>{{ email.pass_word_textnow }}</td>
                                    <td>{{ email.pass_word_textnow_Tf }}</td>
                                    <td>
                                        <div class="status-container">

                                            {% if email.is_reg_TN %}
                                                <div class="status-display" data-status="{{ email.status_reg_account_TN }}">
                                                    {{ email.status_reg_account_TN }}
                                                </div>
                                            {% else %}
                                                <select class="status-select-tn" data-email="{{ email.email }}" default:"{{email.status_reg_account_TN}}">
                                                    <option value="chưa tạo acc" {% if not email.status_reg_account_TN or email.status_reg_account_TN == "chưa tạo acc" %}selected{% endif %}>Chưa tạo acc</option>
                                                    <option value="tạo acc thành công" {% if email.status_reg_account_TN == "tạo acc thành công" %}selected{% endif %}>Tạo acc thành công</option>
                                                    <option value="chưa recend link" {% if email.status_reg_account_TN == "chưa recend link" %}selected{% endif %}>Chưa recend link</option>
                                                    <option value="mail lỗi" {% if email.status_reg_account_TN == "mail lỗi" %}selected{% endif %}>Mail lỗi</option>
                                                    <option value="reg acc lỗi" {% if email.status_reg_account_TN == "reg acc lỗi" %}selected{% endif %}>Reg acc lỗi</option>
                                                </select>
                                            {% endif %}
                                        </div>

                                    </td>

                                    <td>
                                        <div class="status-container">
                                            {% if email.is_reg_TF %}
                                            <div class="status-display" data-status="{{ email.status_reg_account_TF }}">
                                                {{ email.status_reg_account_TF }}
                                            </div>
                                            {% else %}
                                            <select class="status-select-tf" data-email="{{ email.email }}" default:"{{email.status_reg_account_TF}}">
                                                <option value="chưa tạo acc" {% if not email.status_reg_account_TF or email.status_reg_account_TF == "chưa tạo acc" %}selected{% endif %}>Chưa tạo acc</option>
                                                <option value="tạo acc thành công" {% if email.status_reg_account_TF == "tạo acc thành công" %}selected{% endif %}>Tạo acc thành công</option>
                                                <option value="chưa recend link" {% if email.status_reg_account_TF == "chưa recend link" %}selected{% endif %}>Chưa recend link</option>
                                                <option value="mail lỗi" {% if email.status_reg_account_TF == "mail lỗi" %}selected{% endif %}>Mail lỗi</option>
                                                <option value="reg acc lỗi" {% if email.status_reg_account_TF == "reg acc lỗi" %}selected{% endif %}>Reg acc lỗi</option>
                                            </select>
                                            {% endif %}
                                        </div>

                                    </td>
                                    <td>                                            
                                        {% if not email.is_reg_TN %}
                                        <button class="btn btn-sm btn-success create-textnow-btn" 
                                                data-email="{{ email.email }}"
                                                data-password="{{ email.password }}"
                                                data-status="{{ email.status }}"
                                                data-pass-word-textnow="{{ email.pass_word_textnow_TN }}"
                                                data-is-provided="{{ email.is_provided }}"
                                                data-status-reg-account="{{ email.status_reg_account_TN }}"
                                                {% if email.is_reg_TN %}style="display: none;"{% endif %}>
                                              Tạo TN
                                        </button>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if not email.is_reg_TF %}
                                        <button class="btn btn-sm btn-success create-textfree-btn" 
                                                data-email="{{ email.email }}"
                                                data-password="{{ email.password }}"
                                                data-status="{{ email.status }}"
                                                data-pass-word-textnow="{{ email.pass_word_textnow_Tf }}"
                                                data-is-provided="{{ email.is_provided }}"
                                                data-status-reg-account="{{ email.status_reg_account_TF }}"
                                                {% if email.is_reg_TF %}style="display: none;"{% endif %}>
                                              Tạo TF
                                    
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-muted">No emails found</td>
                            </tr>
                        {% endif %}
        </tbody>
    </table>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
            // Hàm lấy giá trị cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            $(document).ready(function() {
                // Thêm hàm để disable/enable tất cả các button và select
                function toggleAllControls(disable) {
                    // Disable/enable tất cả các button
                    $('.create-textnow-btn, .create-textfree-btn, #provideEmailBtn').prop('disabled', disable);
                    // Disable/enable tất cả các select box
                    $('.status-select-tn, .status-select-tf').prop('disabled', disable);
                }

                // Cập nhật xử lý khi thay đổi trạng thái TN
                $('.status-select-tn').change(function() {
                    const email = $(this).data('email');
                    const newStatus = $(this).val();
                    const select = $(this);
                    
                    // Disable tất cả controls và thêm loading
                    toggleAllControls(true);
                    const loadingOverlay = $('<div class="loading-overlay"><div class="loader"><svg viewBox="0 0 100 100" height="100px" width="100px"><defs><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient1"><stop stop-color="#4f8ef7" offset="0%"></stop><stop stop-color="#a663cc" offset="50%"></stop><stop stop-color="#f74f6f" offset="100%"></stop></linearGradient><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient2"><stop stop-color="#f7b34f" offset="0%"></stop><stop stop-color="#5ef7a5" offset="50%"></stop><stop stop-color="#4f8ef7" offset="100%"></stop></linearGradient></defs><circle stroke="url(#gradient1)" r="40" cy="50" cx="50" class="loader-circle circle-1"></circle><circle stroke="url(#gradient2)" r="30" cy="50" cx="50" class="loader-circle circle-2"></circle></svg></div></div>');
                    $('body').append(loadingOverlay);
                    
                    // Gửi AJAX request để cập nhật trạng thái
                    $.ajax({
                        url: '/employee/api/update-status/',
                        method: 'POST',
                        data: JSON.stringify({
                            email: email,
                            status_reg_account_TN: newStatus
                        }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            if (response.success) {
                                // Cập nhật thành công
                                console.log('Status updated successfully');
                                updateSelectColor(select); // Cập nhật màu sắc
                            } else {
                                // Xử lý lỗi
                                console.error('Error updating status:', response.error);
                                alert('Có lỗi xảy ra khi cập nhật trạng thái');
                                // Khôi phục giá trị cũ
                                select.val(select.attr('data-previous-value'));
                                updateSelectColor(select);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX error:', error);
                            alert('Có lỗi xảy ra khi cập nhật trạng thái');
                            // Khôi phục giá trị cũ
                            select.val(select.attr('data-previous-value'));
                            updateSelectColor(select);
                        },
                        complete: function() {
                            // Enable lại tất cả controls và ẩn loading
                            toggleAllControls(false);
                            loadingOverlay.remove();
                        }
                    });
                });

                // Lưu giá trị trước khi thay đổi
                $('.status-select-tn').on('focus', function() {
                    $(this).attr('data-previous-value', $(this).val());
                });

                // Tương tự cho status-select-tf
                $('.status-select-tf').change(function() {
                    const email = $(this).data('email');
                    const newStatus = $(this).val();
                    const select = $(this);
                    
                    // Disable tất cả controls và thêm loading
                    toggleAllControls(true);
                    const loadingOverlay = $('<div class="loading-overlay"><div class="loader"><svg viewBox="0 0 100 100" height="100px" width="100px"><defs><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient1"><stop stop-color="#4f8ef7" offset="0%"></stop><stop stop-color="#a663cc" offset="50%"></stop><stop stop-color="#f74f6f" offset="100%"></stop></linearGradient><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient2"><stop stop-color="#f7b34f" offset="0%"></stop><stop stop-color="#5ef7a5" offset="50%"></stop><stop stop-color="#4f8ef7" offset="100%"></stop></linearGradient></defs><circle stroke="url(#gradient1)" r="40" cy="50" cx="50" class="loader-circle circle-1"></circle><circle stroke="url(#gradient2)" r="30" cy="50" cx="50" class="loader-circle circle-2"></circle></svg></div></div>');
                    $('body').append(loadingOverlay);

                    $.ajax({
                        url: '/employee/api/update-status-tf/',
                        method: 'POST',
                        data: JSON.stringify({
                            email: email,
                            status_reg_account_TF: newStatus
                        }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            if (response.success) {
                                console.log('Status updated successfully');
                                updateSelectColor(select);
                            } else {
                                console.error('Error updating status:', response.error);
                                alert('Có lỗi xảy ra khi cập nhật trạng thái');
                                select.val(select.attr('data-previous-value'));
                                updateSelectColor(select);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX error:', error);
                            alert('Có lỗi xảy ra khi cập nhật trạng thái');
                            select.val(select.attr('data-previous-value'));
                            updateSelectColor(select);
                        },
                        complete: function() {
                            toggleAllControls(false);
                            loadingOverlay.remove();
                        }
                    });
                });

                // Lưu giá trị trước khi thay đổi
                $('.status-select-tf').on('focus', function() {
                    $(this).attr('data-previous-value', $(this).val());
                });

                // Xử lý khi bấm nút Cấp Email Mới
                $('#provideEmailBtn').click(function() {
                    // Disable nút để tránh click nhiều lần
                    const button = $(this);
                    button.prop('disabled', true);
                    
                    // Hiển thị loading
                    const loadingOverlay = $('<div class="loading-overlay"><div class="loader"><svg viewBox="0 0 100 100" height="100px" width="100px"><defs><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient1"><stop stop-color="#4f8ef7" offset="0%"></stop><stop stop-color="#a663cc" offset="50%"></stop><stop stop-color="#f74f6f" offset="100%"></stop></linearGradient><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient2"><stop stop-color="#f7b34f" offset="0%"></stop><stop stop-color="#5ef7a5" offset="50%"></stop><stop stop-color="#4f8ef7" offset="100%"></stop></linearGradient></defs><circle stroke="url(#gradient1)" r="40" cy="50" cx="50" class="loader-circle circle-1"></circle><circle stroke="url(#gradient2)" r="30" cy="50" cx="50" class="loader-circle circle-2"></circle></svg></div></div>');
                    $('body').append(loadingOverlay);

                    // Đợi 2 giây trước khi gửi request
                    setTimeout(function() {
                        $.ajax({
                            url: '/employee/work/?provide_new=true',
                            method: 'GET',
                            success: function(response) {
                                // Reload trang để hiển thị email mới
                                location.reload();
                            },
                            error: function(xhr, status, error) {
                                console.error('AJAX error:', error);
                                alert('Có lỗi xảy ra khi cấp email mới');
                                // Enable lại nút và ẩn loading nếu có lỗi
                                button.prop('disabled', false);
                                loadingOverlay.remove();
                            }
                        });
                    }, 1000); // Delay 2 giây (2000 milliseconds)
                });

                // Xử lý khi bấm nút Tạo Acc TN
                $('.create-textnow-btn').click(function() {
                    const row = $(this).closest('tr');
                    const button = $(this);
                    const statusSelect = row.find('.status-select-tn');
                    const status_reg_account_TN = statusSelect.val();
                    
                    // Kiểm tra trạng thái trước khi gọi API
                    if (status_reg_account_TN == 'chưa tạo acc') {
                        alert('Vui lòng cập nhật trạng thái Reg Acc TN trước khi tạo tài khoản');
                        return;
                    }

                    // Hiển thị loading
                    const loadingOverlay = $('<div class="loading-overlay"><div class="loader"><svg viewBox="0 0 100 100" height="100px" width="100px"><defs><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient1"><stop stop-color="#4f8ef7" offset="0%"></stop><stop stop-color="#a663cc" offset="50%"></stop><stop stop-color="#f74f6f" offset="100%"></stop></linearGradient><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient2"><stop stop-color="#f7b34f" offset="0%"></stop><stop stop-color="#5ef7a5" offset="50%"></stop><stop stop-color="#4f8ef7" offset="100%"></stop></linearGradient></defs><circle stroke="url(#gradient1)" r="40" cy="50" cx="50" class="loader-circle circle-1"></circle><circle stroke="url(#gradient2)" r="30" cy="50" cx="50" class="loader-circle circle-2"></circle></svg></div></div>');
                    $('body').append(loadingOverlay);

                    const emailData = {
                        email: row.find('td:eq(1)').text(),
                        password_email: row.find('td:eq(2)').text(),
                        password: row.find('td:eq(4)').text(),
                        status_account_TN: status_reg_account_TN,
                        supplier: 'QUÂN',
                        refresh_token: row.find('td:eq(1)').data('refresh-token') || '',
                        client_id: row.find('td:eq(1)').data('client-id') || ''
                    };

                    $.ajax({
                        url: '/employee/api/create-textnow/',
                        method: 'POST',
                        data: JSON.stringify({
                            email: emailData.email,
                            password_email: emailData.password_email,
                            password: emailData.password,
                            status_account_TN: emailData.status_account_TN,
                            supplier: emailData.supplier,
                            refresh_token: emailData.refresh_token,
                            client_id: emailData.client_id
                        }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            if (response.success) {
                                button.hide();
                                
                                const statusDiv = $('<div>')
                                    .addClass('status-display')
                                    .attr('data-status', emailData.status_account_TN)
                                    .text(emailData.status_account_TN);
                                
                                statusSelect.hide();
                                statusSelect.after(statusDiv);
                                
                                alert('Tạo tài khoản TextNow thành công');
                            } else {
                                alert('Lỗi: ' + response.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX error:', error);
                            console.error('Response:', xhr.responseText);
                            alert('Có lỗi xảy ra khi tạo tài khoản TextNow', error);
                        },
                        complete: function() {
                            loadingOverlay.remove();
                        }
                    });
                });

                // Xử lý khi bấm nút Tạo Acc TF
                $('.create-textfree-btn').click(function() {
                    const row = $(this).closest('tr');
                    const button = $(this);
                    const statusSelect = row.find('.status-select-tf');
                    const status_reg_account_TF = statusSelect.val();
                    
                    // Kiểm tra trạng thái trước khi gọi API
                    if (status_reg_account_TF == 'chưa tạo acc') {
                        alert('Vui lòng cập nhật trạng thái Reg Acc TF trước khi tạo tài khoản');
                        return;
                    }

                    // Hiển thị loading
                    const loadingOverlay = $('<div class="loading-overlay"><div class="loader"><svg viewBox="0 0 100 100" height="100px" width="100px"><defs><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient1"><stop stop-color="#4f8ef7" offset="0%"></stop><stop stop-color="#a663cc" offset="50%"></stop><stop stop-color="#f74f6f" offset="100%"></stop></linearGradient><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient2"><stop stop-color="#f7b34f" offset="0%"></stop><stop stop-color="#5ef7a5" offset="50%"></stop><stop stop-color="#4f8ef7" offset="100%"></stop></linearGradient></defs><circle stroke="url(#gradient1)" r="40" cy="50" cx="50" class="loader-circle circle-1"></circle><circle stroke="url(#gradient2)" r="30" cy="50" cx="50" class="loader-circle circle-2"></circle></svg></div></div>');
                    $('body').append(loadingOverlay);

                    const emailData = {
                        email: row.find('td:eq(1)').text(),
                        password_email: row.find('td:eq(2)').text(),
                        password: row.find('td:eq(4)').text(),
                        status_account_TF: status_reg_account_TF,
                        supplier: 'QUÂN',
                        refresh_token: row.find('td:eq(1)').data('refresh-token') || '',
                        client_id: row.find('td:eq(1)').data('client-id') || ''
                    };

                    $.ajax({
                        url: '/employee/api/create-textfree/',
                        method: 'POST',
                        data: JSON.stringify({
                            email: emailData.email,
                            password_email: emailData.password_email,
                            password: emailData.password,
                            status_account_TF: emailData.status_account_TF,
                            supplier: emailData.supplier,
                            refresh_token: emailData.refresh_token,
                            client_id: emailData.client_id
                        }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            if (response.success) {
                                button.hide();
                                
                                const statusDiv = $('<div>')
                                    .addClass('status-display')
                                    .attr('data-status', emailData.status_account_TF)
                                    .text(emailData.status_account_TF);
                                
                                statusSelect.hide();
                                statusSelect.after(statusDiv);
                                
                                alert('Tạo tài khoản TextFree thành công');
                            } else {
                                alert('Lỗi: ' + response.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX error:', error);
                            console.error('Response:', xhr.responseText);
                            alert('Có lỗi xảy ra khi tạo tài khoản TextFree', error);
                        },
                        complete: function() {
                            loadingOverlay.remove();
                        }
                    });
                });

                // Thêm đoạn JavaScript để cập nhật màu sắc khi thay đổi giá trị
                function updateSelectColor(select) {
                    const value = $(select).val();
                    $(select).attr('data-value', value);
                }

                // Cập nhật màu sắc ban đầu cho tất cả select box
                $('.status-select-tn, .status-select-tf').each(function() {
                    updateSelectColor(this);
                });

                // Cập nhật màu sắc khi thay đổi giá trị
                $('.status-select-tn, .status-select-tf').change(function() {
                    updateSelectColor(this);
                });

                // Xử lý nút cập nhật hàng loạt TN
                $('#bulkCreateTNBtn').click(function() {
                    const button = $(this);
                    button.prop('disabled', true);

                    // Hiển thị loading
                    const loadingOverlay = $('<div class="loading-overlay"><div class="loader"><svg viewBox="0 0 100 100" height="100px" width="100px"><defs><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient1"><stop stop-color="#4f8ef7" offset="0%"></stop><stop stop-color="#a663cc" offset="50%"></stop><stop stop-color="#f74f6f" offset="100%"></stop></linearGradient><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient2"><stop stop-color="#f7b34f" offset="0%"></stop><stop stop-color="#5ef7a5" offset="50%"></stop><stop stop-color="#4f8ef7" offset="100%"></stop></linearGradient></defs><circle stroke="url(#gradient1)" r="40" cy="50" cx="50" class="loader-circle circle-1"></circle><circle stroke="url(#gradient2)" r="30" cy="50" cx="50" class="loader-circle circle-2"></circle></svg></div></div>');
                    $('body').append(loadingOverlay);

                    // Tìm tất cả email thỏa điều kiện
                    const eligibleEmails = [];
                    $('.email-row').each(function() {
                        const row = $(this);
                        const statusTNSelect = row.find('.status-select-tn');
                        const statusTFSelect = row.find('.status-select-tf');
                        const createTNButton = row.find('.create-textnow-btn');
                        
                        // Kiểm tra điều kiện:
                        // 1. Status Reg TN khác "chưa tạo acc"
                        // 2. Nút "Tạo TN" vẫn còn hiển thị (tức là is_reg_TN = false)
                        if (statusTNSelect.val() !== 'chưa tạo acc' && createTNButton.length > 0) {
                            const emailData = {
                                email: row.find('td:eq(1)').text(),
                                password_email: row.find('td:eq(2)').text(),
                                password: row.find('td:eq(3)').text(),
                                status_account_TF: statusTFSelect.val(),
                                supplier: 'QUÂN',
                                refresh_token: row.find('td:eq(1)').data('refresh-token') || '',
                                client_id: row.find('td:eq(1)').data('client-id') || ''
                            };
                            eligibleEmails.push(emailData);
                        }
                    });

                    if (eligibleEmails.length === 0) {
                        alert('Không tìm thấy email nào thỏa điều kiện!\n(Status Reg TN khác "chưa tạo acc" và chưa reg TN)');
                        button.prop('disabled', false);
                        loadingOverlay.remove();
                        return;
                    }

                    // console.log('Tổng số email thỏa điều kiện:', eligibleEmails.length);
                    // console.log('Danh sách email:', eligibleEmails);

                    // Gọi API với danh sách email
                    $.ajax({
                        url: '/employee/api/create-multiple-textnow/',
                        method: 'POST',
                        data: JSON.stringify({
                            accounts: eligibleEmails
                        }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            if (response.success) {
                                // Cập nhật UI cho các email đã xử lý thành công
                                response.data.created_accounts.forEach(account => {
                                    const row = $(`tr:contains("${account.email}")`);
                                    const statusSelect = row.find('.status-select-tn');
                                    const createButton = row.find('.create-textnow-btn');

                                    // Ẩn nút tạo
                                    createButton.hide();

                                    // Thay thế select box bằng div hiển thị trạng thái
                                    const statusDiv = $('<div>')
                                        .addClass('status-display')
                                        .attr('data-status', account.status_account)
                                        .text(account.status_account);

                                    statusSelect.hide();
                                    statusSelect.after(statusDiv);
                                });

                                // Hiển thị thông báo kết quả
                                alert(`Đã xử lý thành công ${response.data.created_accounts.length} tài khoản\n` +
                                      `Thất bại: ${response.data.failed_accounts.length} tài khoản`);
                            } else {
                                alert('Lỗi: ' + response.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX error:', error);
                            console.error('Response:', xhr.responseText);
                            alert('Có lỗi xảy ra khi tạo tài khoản hàng loạt');
                        },
                        complete: function() {
                            button.prop('disabled', false);
                            loadingOverlay.remove();
                        }
                    });
                });

                // Xử lý nút cập nhật hàng loạt TF
                $('#bulkCreateTFBtn').click(function() {
                    const button = $(this);
                    button.prop('disabled', true);

                    // Hiển thị loading
                    const loadingOverlay = $('<div class="loading-overlay"><div class="loader"><svg viewBox="0 0 100 100" height="100px" width="100px"><defs><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient1"><stop stop-color="#4f8ef7" offset="0%"></stop><stop stop-color="#a663cc" offset="50%"></stop><stop stop-color="#f74f6f" offset="100%"></stop></linearGradient><linearGradient y2="0%" x2="100%" y1="0%" x1="0%" id="gradient2"><stop stop-color="#f7b34f" offset="0%"></stop><stop stop-color="#5ef7a5" offset="50%"></stop><stop stop-color="#4f8ef7" offset="100%"></stop></linearGradient></defs><circle stroke="url(#gradient1)" r="40" cy="50" cx="50" class="loader-circle circle-1"></circle><circle stroke="url(#gradient2)" r="30" cy="50" cx="50" class="loader-circle circle-2"></circle></svg></div></div>');
                    $('body').append(loadingOverlay);

                    // Tìm tất cả email thỏa điều kiện
                    const eligibleEmails = [];
                    $('.email-row').each(function() {
                        const row = $(this);
                        const statusTNSelect = row.find('.status-select-tn');
                        const statusTFSelect = row.find('.status-select-tf');
                        const createTNButton = row.find('.create-textnow-btn');
                        
                        // Kiểm tra điều kiện:
                        // 1. Status Reg TN khác "chưa tạo acc"
                        // 2. Nút "Tạo TN" vẫn còn hiển thị (tức là is_reg_TN = false)
                        if (statusTNSelect.val() !== 'chưa tạo acc' && createTNButton.length > 0) {
                            const emailData = {
                                email: row.find('td:eq(1)').text(),
                                password_email: row.find('td:eq(2)').text(),
                                password: row.find('td:eq(3)').text(),
                                status_account_TF: statusTFSelect.val(),
                                supplier: 'QUÂN',
                                refresh_token: row.find('td:eq(1)').data('refresh-token') || '',
                                client_id: row.find('td:eq(1)').data('client-id') || ''
                            };
                            eligibleEmails.push(emailData);
                        }
                    });

                    if (eligibleEmails.length === 0) {
                        alert('Không tìm thấy email nào thỏa điều kiện!\n(Status Reg TN khác "chưa tạo acc" và chưa reg TN)');
                        button.prop('disabled', false);
                        loadingOverlay.remove();
                        return;
                    }

                    // console.log('Tổng số email thỏa điều kiện:', eligibleEmails.length);
                    // console.log('Danh sách email:', eligibleEmails);

                    // Gọi API với danh sách email
                    $.ajax({
                        url: '/employee/api/create-multiple-textfree/',
                        method: 'POST',
                        data: JSON.stringify({
                            accounts: eligibleEmails
                        }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            if (response.success) {
                                // Cập nhật UI cho các email đã xử lý thành công
                                response.data.created_accounts.forEach(account => {
                                    const row = $(`tr:contains("${account.email}")`);
                                    const statusSelect = row.find('.status-select-tf');
                                    const createButton = row.find('.create-textfree-btn');

                                    // Ẩn nút tạo
                                    createButton.hide();

                                    // Thay thế select box bằng div hiển thị trạng thái
                                    const statusDiv = $('<div>')
                                        .addClass('status-display')
                                        .attr('data-status', account.status_account)
                                        .text(account.status_account);

                                    statusSelect.hide();
                                    statusSelect.after(statusDiv);
                                });

                                // Hiển thị thông báo kết quả
                                alert(`Đã xử lý thành công ${response.data.created_accounts.length} tài khoản\n` +
                                      `Thất bại: ${response.data.failed_accounts.length} tài khoản`);
                            } else {
                                alert('Lỗi: ' + response.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX error:', error);
                            console.error('Response:', xhr.responseText);
                            alert('Có lỗi xảy ra khi tạo tài khoản hàng loạt');
                        },
                        complete: function() {
                            button.prop('disabled', false);
                            loadingOverlay.remove();
                        }
                    });
                });
            });
    </script>
</body>
</html>
